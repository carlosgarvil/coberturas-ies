<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coberturas IES ¬∑ Generador por ausencias</title>
  <style>
    :root{--bg:#0b1020;--panel:#121a2c;--muted:#8ea0bf;--text:#e6eefc;--brand:#6aa9ff;--accent:#9df28c;--warn:#ffd36a;--danger:#ff7a7a;--chip:#1b2742}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1020 60%,#0e1630);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.85);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid #1d2742}
    .container{max-width:1200px;margin:auto;padding:18px}
    h1{font-size:20px;margin:0;letter-spacing:.3px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-2{grid-template-columns:320px 1fr}}
    .card{background:var(--panel);border:1px solid #1d2742;border-radius:16px;box-shadow:0 10px 30px rgba(5,10,20,.3);}
    .card h2{font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin:0 0 6px}
    .card .body{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], select, button, .btn{font:inherit}
    input[type="text"], select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3555;background:#0f1730;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #243255;color:#cfe0ff;font-size:12px}
    .pill button{all:unset;cursor:pointer;color:#9fbaff}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar .seg{display:inline-flex;border:1px solid #2a3555;border-radius:12px;overflow:hidden}
    .seg button{padding:8px 12px;background:#0f1730;border:none;cursor:pointer;color:#cfe0ff}
    .seg button[aria-pressed="true"]{background:#1a2444;color:#cfe0ff}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #2a3555;background:#0f1730;color:#e6eefc;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#6aa9ff,#4d8ef0);border:none;color:#08142b}
    .btn.ghost{background:#0f1730}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0f1730;text-align:left;font-size:12px;color:#9bb0d8;border-bottom:1px solid #25335a;padding:10px}
    tbody td{border-bottom:1px solid #1c294d;padding:10px;vertical-align:top}
    tbody tr:hover{background:#0f1836}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0f1730;border:1px solid #2a3555;border-radius:6px;padding:1px 6px;color:#cfe0ff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #2a3555;background:#0f1730}
    .ok{color:var(--accent)}.warn{color:var(--warn)}.danger{color:var(--danger)}
    .hr{height:1px;background:#1d2742;margin:14px 0}
    .upload-zone{border:1px dashed #355197;border-radius:12px;padding:14px;text-align:center;background:#0f1730}
    .small{font-size:12px}
    .alert{margin-top:8px;padding:10px 12px;border:1px solid #5a2;border-radius:10px;background:#0f1a0f;color:#cfe0cf;display:none}
    .toast{position:fixed;right:16px;bottom:16px;background:#11233f;color:#dbe9ff;border:1px solid #2a3555;padding:10px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <h1>üéì Coberturas IES ¬∑ Generador por ausencias</h1>
      <div class="muted small">Carga el horario TSV ¬∑ Elige d√≠a y docentes ausentes ¬∑ Exporta/ Copia</div>
    </div>
  </header>

  <main class="container grid grid-2" style="margin-top:16px">
    <section class="card">
      <div class="body">
        <h2>Datos</h2>
        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept=".tsv,.txt,text/tab-separated-values,text/plain" />
          <div class="hint">Archivo con 6 columnas separadas por tabulador: <span class="kbd">Asignatura</span> <span class="kbd">Grupo</span> <span class="kbd">Aula</span> <span class="kbd">Docente</span> <span class="kbd">Dia</span> <span class="kbd">Hora</span></div>
        </div>

        <div id="dataOk" style="display:none;margin-top:10px" class="small">
          ‚úÖ Horario cargado. <span id="statClases" class="badge"></span> ¬∑ <span id="statDocentes" class="badge"></span>
        </div>
        <div id="warnNoTeachers" class="alert">‚ö†Ô∏è Se ha cargado el archivo, pero no se han detectado docentes. Revisa el separador (tabulador) y que la columna 4 sea el nombre del docente.</div>

        <div class="hr"></div>

        <h2>Par√°metros</h2>
        <label for="daySel">D√≠a</label>
        <div class="toolbar">
          <div class="seg" role="tablist" aria-label="D√≠a de la semana">
            <button class="dayBtn" data-day="L" aria-pressed="true">L</button>
            <button class="dayBtn" data-day="M" aria-pressed="false">M</button>
            <button class="dayBtn" data-day="X" aria-pressed="false">X</button>
            <button class="dayBtn" data-day="J" aria-pressed="false">J</button>
            <button class="dayBtn" data-day="V" aria-pressed="false">V</button>
          </div>
          <div class="seg" role="tablist" aria-label="Pol√≠tica de cobertura">
            <button class="policyBtn" data-policy="any" aria-pressed="true" title="Marca cobertura si falta alguno, pero se ignora si queda otro docente presente">ANY</button>
            <button class="policyBtn" data-policy="all" aria-pressed="false" title="Solo si faltan todos los docentes del slot">ALL</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <label style="margin:0"><input type="checkbox" id="ignoreCoTeach" checked /> Ignorar cobertura si queda co-docente presente</label>
          <label style="margin:0"><input type="checkbox" id="excludeSupport" /> Excluir APOYO/√ÅMBITO/REFUERZO</label>
        </div>

        <label for="filter">Filtrar docentes</label>
        <input type="text" id="filter" placeholder="Escribe para filtrar (apellidos o nombre)‚Ä¶" />

        <label for="teachers">Docentes ausentes (selecci√≥n m√∫ltiple)</label>
        <div class="row">
          <select id="teachers" multiple size="12" style="flex:1"></select>
          <div class="grid" style="width:260px">
            <button class="btn" id="btnAdd">‚ûï A√±adir ‚Üí</button>
            <button class="btn" id="btnRemove">‚Üê Quitar</button>
            <button class="btn ghost" id="btnClearSel">Limpiar selecci√≥n</button>
          </div>
        </div>

        <div class="row" id="chosenRow" style="margin-top:6px"></div>

        <div class="hr"></div>
        <div class="row">
          <button class="btn primary" id="btnGenerate">‚èµ Generar tabla</button>
          <button class="btn" id="btnExport" disabled>‚§ì Exportar CSV</button>
          <button class="btn" id="btnCopy" disabled>üìã Copiar tabla</button>
          <button class="btn" id="btnExportHTML" disabled>üßæ Exportar HTML din√°mico</button>
        </div>
        <div class="hint">Consejo: usa <span class="kbd">Ctrl/Cmd</span> para selecci√≥n m√∫ltiple, o haz doble clic en un nombre para a√±adirlo r√°pido.</div>
      </div>
    </section>

    <section class="card">
      <div class="body">
        <h2>Resultado</h2>
        <div id="summary" class="muted small" style="margin-bottom:8px">Carga un horario y selecciona ausencias para ver resultados. (Recreos excluidos)</div>
        <div style="overflow:auto;max-height:70vh;border:1px solid #1d2742;border-radius:12px">
          <table id="resultTable">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Grupo</th>
                <th>Aula</th>
                <th>Ausentes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">‚úÖ Tabla copiada al portapapeles</div>

  <script>
  const dayNames = {L:'Lunes', M:'Martes', X:'Mi√©rcoles', J:'Jueves', V:'Viernes'};
  const supportRegex = /(\bAPOYO\b|\bAPOYO PT\b|\bAMBITO\b|\b√ÅMBITO\b|\bATENCION EDUCATIVA\b|\bATENCI√ìN EDUCATIVA\b|\bREFUERZO\b)/i;
  const BREAK_SLOTS = new Set([4, 11]);
  const EXCLUDED_SUBJECTS = new Set([
    "Guardia Biblioteca Recreo","Guardia Alegria","Guardia Buleria","Guardia Tarde",
    "Guardia Biblioteca","Guardia Recreo PT"
  ]);

  function slotToLabel(n){
    const map = {
      1: '08:15‚Äì09:15', 2: '09:15‚Äì10:15', 3: '10:15‚Äì11:15',
      4: 'RECREO 11:15‚Äì11:45',
      5: '11:45‚Äì12:45', 6: '12:45‚Äì13:45', 7: '13:45‚Äì14:45',
      8: '15:00‚Äì16:00', 9: '16:00‚Äì17:00', 10: '17:00‚Äì18:00',
      11: 'RECREO 18:00‚Äì18:15',
      12: '18:15‚Äì19:15', 13: '19:15‚Äì20:15', 14: '20:15‚Äì21:15',
    };
    return map[n] || String(n);
  }

  const SLOT_RANGES = [
    [1,  8*60+15,  9*60+15],
    [2,  9*60+15, 10*60+15],
    [3, 10*60+15, 11*60+15],
    [4, 11*60+15, 11*60+45],
    [5, 11*60+45, 12*60+45],
    [6, 12*60+45, 13*60+45],
    [7, 13*60+45, 14*60+45],
    [8, 15*60+0,  16*60+0],
    [9, 16*60+0,  17*60+0],
    [10,17*60+0,  18*60+0],
    [11,18*60+0,  18*60+15],
    [12,18*60+15, 19*60+15],
    [13,19*60+15, 20*60+15],
    [14,20*60+15, 21*60+15],
  ];

  function detectDelimiterSmart(lines){
    const candidates = ['\t',';'];
    let best = '\t', bestScore = -1;
    for(const cand of candidates){
      let ok = 0;
      for(const line of lines.slice(0,50)){
        const parts = line.split(cand);
        if(parts.length >= 6){
          const hora = Number(cleanCell(parts[5]));
          if(!Number.isNaN(hora) && hora >= 1 && hora <= 14) ok++;
        }
      }
      if(ok > bestScore){ bestScore = ok; best = cand; }
    }
    return best;
  }

  function cleanCell(s){
    if(s==null) return '';
    s = String(s).trim();
    if((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))){
      s = s.slice(1,-1);
    }
    return s.trim();
  }

  function parseTSV(text){
    const lines = text.replace(/\u0000/g,'').split(/\r?\n/).filter(l=>l.trim().length>0);
    if(!lines.length) return [];
    const delim = detectDelimiterSmart(lines);
    const recs = [];
    for(const line of lines){
      const parts = line.split(delim);
      if(parts.length < 6) continue;
      const Hora = Number(cleanCell(parts[5]));
      if(Number.isNaN(Hora) || Hora < 1 || Hora > 14) continue;
      const Asignatura = cleanCell(parts[0]);
      const Grupo = cleanCell(parts[1]);
      const Aula = cleanCell(parts[2]);
      const Docente = cleanCell(parts[3]);
      const Dia = cleanCell(parts[4]);
      recs.push({
        Asignatura, Grupo, Aula, Docente, Dia, Hora,
        Dia_full: dayNames[Dia]||Dia,
        Es_Apoyo_o_Ambito: supportRegex.test(Asignatura),
        SlotKey: `${Grupo} | ${Dia} | ${Hora}`
      });
    }
    return recs;
  }

  function computeCoverage(records, {day='L', absents=[], policy='any', excludeSupport=false, ignoreCoTeach=true}){
    const dayRecs = records.filter(r =>
      r.Dia === day &&
      !BREAK_SLOTS.has(r.Hora) &&
      !EXCLUDED_SUBJECTS.has(r.Asignatura) &&
      (!excludeSupport || !r.Es_Apoyo_o_Ambito)
    );
    const bySlot = new Map();
    for(const r of dayRecs){
      if(!bySlot.has(r.SlotKey)) bySlot.set(r.SlotKey, {meta: {...r}, teachers: new Set(), subjects: new Set(), aulas: new Set()});
      const s = bySlot.get(r.SlotKey);
      s.teachers.add(r.Docente);
      s.subjects.add(r.Asignatura);
      if(r.Aula && r.Aula.trim()) s.aulas.add(r.Aula);
    }

    const out = [];
    for(const [key, s] of bySlot){
      const assigned = [...s.teachers].sort();
      const aus = assigned.filter(t => absents.includes(t)).sort();
      const pres = assigned.filter(t => !absents.includes(t)).sort();
      let needs = false;
      if(policy === 'all'){
        needs = assigned.length>0 && aus.length === assigned.length;
      }else{
        needs = aus.length>0;
        if(ignoreCoTeach) needs = needs && pres.length === 0;
      }
      if(needs){
        out.push({
          Dia_full: s.meta.Dia_full,
          Dia: s.meta.Dia,
          Hora: s.meta.Hora,
          Grupo: s.meta.Grupo,
          Aula: [...s.aulas].join(', '),
          Asignaturas: [...s.subjects].sort().join(' ¬∑ '),
          Docentes_asignados: assigned.join(' ¬∑ '),
          Docentes_presentes: pres.join(' ¬∑ '),
          Docentes_ausentes: aus.join(' ¬∑ '),
          SlotKey: key
        });
      }
    }
    out.sort((a,b)=> a.Hora - b.Hora || a.Grupo.localeCompare(b.Grupo));
    return out;
  }

  function toCSV(rows){
    if(!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = v => '\"'+String(v??'').replace(/\"/g,'\"\"')+'\"';
    const lines = [headers.map(esc).join(',')];
    for(const r of rows){ lines.push(headers.map(h=>esc(r[h])).join(',')); }
    return lines.join('\n');
  }

  let records = [];
  let teachers = [];
  let chosen = new Set();
  let state = {day:'L', policy:'any', ignoreCoTeach:true, excludeSupport:false};

  const $file = document.getElementById('fileInput');
  const $dataOk = document.getElementById('dataOk');
  const $warnNoTeachers = document.getElementById('warnNoTeachers');
  const $statClases = document.getElementById('statClases');
  const $statDocentes = document.getElementById('statDocentes');
  const $filter = document.getElementById('filter');
  const $teachers = document.getElementById('teachers');
  const $chosenRow = document.getElementById('chosenRow');
  const $btnAdd = document.getElementById('btnAdd');
  const $btnRemove = document.getElementById('btnRemove');
  const $btnClearSel = document.getElementById('btnClearSel');
  const $btnGenerate = document.getElementById('btnGenerate');
  const $btnExport = document.getElementById('btnExport');
  const $btnCopy = document.getElementById('btnCopy');
  const $btnExportHTML = document.getElementById('btnExportHTML');
  const $summary = document.getElementById('summary');
  const $tbody = document.querySelector('#resultTable tbody');
  const $toast = document.getElementById('toast');

  $file.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    if(!/\.(tsv|txt)$/i.test(f.name)){
      alert('Has seleccionado: '+f.name+'\nEste generador solo admite archivos .tsv o .txt con 6 columnas.\nSi quer√≠as abrir el HTML exportado, √°brelo directamente en el navegador (no lo cargues aqu√≠).');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const text = String(reader.result||'').trim();
        records = parseTSV(text);
        teachers = [...new Set(records.map(r=>r.Docente).filter(Boolean))].sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
        renderTeacherOptions();
        $dataOk.style.display = 'block';
        $warnNoTeachers.style.display = teachers.length ? 'none' : 'block';
        $statClases.textContent = `${records.length} filas`;
        $statDocentes.textContent = `${teachers.length} docentes`;
        if(records.length===0 || teachers.length===0){
          alert('El archivo se ha le√≠do, pero no parece un horario v√°lido (no se encuentran filas con 6 columnas y la √∫ltima num√©rica 1‚Äì14).\n¬øHas cargado por error un HTML o un CSV con otro separador?');
        }
        $summary.textContent = 'Horario cargado. (Recreos excluidos) Selecciona d√≠a y docentes ausentes para generar la tabla.';
        console.debug('[Coberturas] Cargado:', {filas: records.length, docentes: teachers.length});
      }catch(err){
        console.error('Error procesando el fichero:', err);
        alert('No se ha podido procesar el fichero. Revisa que sea .tsv con 6 columnas (Asignatura,Grupo,Aula,Docente,Dia,Hora).');
      }
    };
    reader.readAsText(f, 'latin1');
  });

  function renderTeacherOptions(){
    const term = $filter.value.trim().toLowerCase();
    $teachers.innerHTML='';
    for(const t of teachers){
      if(term && !t.toLowerCase().includes(term)) continue;
      if(chosen.has(t)) continue;
      const opt = document.createElement('option');
      opt.value=t; opt.textContent=t;
      $teachers.appendChild(opt);
    }
    renderChosenPills();
  }

  function renderChosenPills(){
    $chosenRow.innerHTML='';
    if(chosen.size===0){
      const span = document.createElement('span');
      span.className='muted small';
      span.textContent='(Sin ausencias seleccionadas)';
      $chosenRow.appendChild(span);
      return;
    }
    for(const t of [...chosen].sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}))){
      const pill = document.createElement('span');
      pill.className='pill';
      pill.innerHTML = `<span>üë§</span><span>${t}</span>`;
      const x = document.createElement('button');
      x.textContent='‚úï';
      x.title='Quitar';
      x.onclick = ()=>{ chosen.delete(t); renderTeacherOptions(); };
      pill.appendChild(x);
      $chosenRow.appendChild(pill);
    }
  }

  $filter.addEventListener('input', renderTeacherOptions);

  $teachers.addEventListener('dblclick', (e)=>{
    const target = e.target;
    if(target && target.tagName === 'OPTION'){
      chosen.add(target.value);
      renderTeacherOptions();
    }
  });

  $btnAdd.addEventListener('click', ()=>{
    for(const opt of [...$teachers.selectedOptions]){
      chosen.add(opt.value);
    }
    renderTeacherOptions();
  });
  $btnRemove.addEventListener('click', ()=>{
    if(chosen.size){ chosen.delete([...chosen].pop()); renderTeacherOptions(); }
  });
  $btnClearSel.addEventListener('click', ()=>{ chosen.clear(); renderTeacherOptions(); });

  document.querySelectorAll('.dayBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.dayBtn').forEach(b=>b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      state.day = btn.dataset.day;
    });
  });
  document.querySelectorAll('.policyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.policyBtn').forEach(b=>b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      state.policy = btn.dataset.policy;
    });
  });
  document.getElementById('ignoreCoTeach').addEventListener('change', e=> state.ignoreCoTeach = e.target.checked);
  document.getElementById('excludeSupport').addEventListener('change', e=> state.excludeSupport = e.target.checked);

  function computeCoverageCurrent(){
    const abs = [...chosen];
    return computeCoverage(records, {day: state.day, absents: abs, policy: state.policy, excludeSupport: state.excludeSupport, ignoreCoTeach: state.ignoreCoTeach});
  }

  function renderTable(rows){
    $tbody.innerHTML='';
    if(rows.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td'); td.colSpan=7; td.className='muted'; td.textContent='No hay clases a cubrir con los criterios actuales.';
      tr.appendChild(td); $tbody.appendChild(tr); return;
    }
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.dataset.slot = String(r.Hora);
      tr.innerHTML = `
        <td><strong>${slotToLabel(r.Hora)}</strong></td>
        <td>${r.Grupo}</td>
        <td>${r.Aula||''}</td>
        <td class="danger">${r.Docentes_ausentes||'‚Äî'}</td>`;
      $tbody.appendChild(tr);
    }
  }

  $btnGenerate.addEventListener('click', ()=>{
    if(!records.length){ alert('Primero carga el archivo de horarios (TSV).'); return; }
    const rows = computeCoverageCurrent();
    renderTable(rows);
    const hasRows = rows.length>0;
    $btnExport.disabled = !hasRows;
    $btnCopy.disabled = !hasRows;
    $btnExportHTML.disabled = !hasRows;
    const resumen = `${dayNames[state.day]} ‚Äî ${rows.length} clase(s) a cubrir ¬∑ Pol√≠tica: ${state.policy.toUpperCase()}${state.ignoreCoTeach?' (co-docencia cubierta)':''}${state.excludeSupport?' ¬∑ sin APOYO/√ÅMBITO':''} ¬∑ recreos excluidos`;
    $summary.textContent = resumen;
  });

  function copyTable(){
    const rows = computeCoverageCurrent();
    if(!rows.length){ return; }
    const header = ['Hora','Grupo','Aula','Ausentes'];
    const lines = [header.join('\t')];
    for(const r of rows){
      lines.push([slotToLabel(r.Hora), r.Grupo, r.Aula||'', r.Docentes_ausentes||'‚Äî'].join('\t'));
    }
    const text = lines.join('\n');
    navigator.clipboard.writeText(text).then(()=>{
      $toast.textContent = '‚úÖ Tabla copiada al portapapeles';
      $toast.classList.add('show');
      setTimeout(()=> $toast.classList.remove('show'), 1800);
    });
  }
  $btnCopy.addEventListener('click', copyTable);

  function buildExportHTML(){
    const rows = computeCoverageCurrent();
    const day = state.day;
    const title = `Coberturas ‚Äî ${dayNames[day]} (din√°mico)`;
    const tableRows = rows.map(r => {
      const hora = slotToLabel(r.Hora);
      const grupo = r.Grupo;
      const aula = r.Aula || '';
      const aus = r.Docentes_ausentes || '‚Äî';
      return `<tr data-slot="${r.Hora}"><td><strong>${hora}</strong></td><td>${grupo}</td><td>${aula}</td><td class="danger">${aus}</td></tr>`;
    }).join("\n");

    const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${title}</title>
<style>
  :root{--bg:#0b1020;--panel:#121a2c;--muted:#8ea0bf;--text:#e6eefc;--hi:#223a73;--hi2:#3154a9}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:#0b1020;color:#e6eefc}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#0f1730;border-bottom:1px solid #26345b;position:sticky;top:0}
  h1{font-size:18px;margin:0}
  #clock{font-variant-numeric:tabular-nums;color:#bcd3ff}
  main{padding:16px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:54px;background:#0f1730;text-align:left;font-size:12px;color:#9bb0d8;border-bottom:1px solid #25335a;padding:10px}
  tbody td{border-bottom:1px solid #1c294d;padding:10px;vertical-align:top}
  tr.now{background:linear-gradient(90deg, rgba(49,84,169,.22), rgba(49,84,169,.05));}
  tr.now td{border-bottom-color:#3154a9}
  .danger{color:#ff9a9a}
  .muted{color:#8ea0bf;font-size:12px;margin:6px 0 0}
</style>
</head>
<body>
<header>
  <h1>${title}</h1>
  <div id="clock">--:--:--</div>
</header>
<main>
  <div class="muted">La fila actual se resalta autom√°ticamente seg√∫n la hora local del navegador. Recreos excluidos.</div>
  <div style="overflow:auto;max-height:80vh;border:1px solid #1d2742;border-radius:12px">
    <table>
      <thead><tr><th>Hora</th><th>Grupo</th><th>Aula</th><th>Ausentes</th></tr></thead>
      <tbody id="tbody">
        ${tableRows}
      </tbody>
    </table>
  </div>
</main>
<script>
  const SLOT_RANGES = ${JSON.stringify(SLOT_RANGES)};
  function pad(n){return String(n).padStart(2,'0')}
  function currentSlot(){
    const now = new Date();
    const m = now.getHours()*60 + now.getMinutes();
    for(const [slot, start, end] of SLOT_RANGES){
      if(m >= start && m < end) return slot;
    }
    return null;
  }
  function tick(){
    const now = new Date();
    const h = pad(now.getHours()), mi = pad(now.getMinutes()), s = pad(now.getSeconds());
    document.getElementById('clock').textContent = h+':'+mi+':'+s;
    const slot = currentSlot();
    const rows = document.querySelectorAll('#tbody tr');
    rows.forEach(tr => tr.classList.remove('now'));
    if(slot!=null){
      const tr = document.querySelector('#tbody tr[data-slot="'+slot+'"]');
      if(tr){ tr.classList.add('now'); tr.scrollIntoView({block:'center', behavior:'smooth'}); }
    }
  }
  tick();
  setInterval(tick, 15000);
<\/script>
</body>
</html>`;
    return html;
  }

  function exportHTML(){
    const html = buildExportHTML();
    const blob = new Blob([html], {type:'text/html;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const day = state.day;
    a.download = `coberturas_${day}_dinamico.html`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  $btnExportHTML.addEventListener('click', exportHTML);

  $btnExport.addEventListener('click', ()=>{
    const rows = computeCoverageCurrent();
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `coberturas_${state.day}_${state.policy}${state.ignoreCoTeach?'_nocoteach':''}${state.excludeSupport?'_noapoyo':''}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  });
  </script>
</body>
</html>
